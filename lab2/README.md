# Лабораторная работа 2

## Генерация тестовых данных

### Цели работы

Сформировать набор данных, позволяющий производить операции на реальных объемах данных.

### Программа работы

1. Реализация в виде программы параметризуемого генератора, который позволит сформировать набор связанных данных в каждой таблице.
2. Частные требования к генератору, набору данных и результирующему набору данных:
    - количество записей в справочных таблицах должно соответствовать ограничениям предметной области
    - количество записей в таблицах, хранящих информацию об объектах или субъектах должно быть параметром генерации
    - значения для внешних ключей необходимо брать из связанных таблиц
    - сохранение уже имеющихся данных в базе данных

### Ход работы

Для выполнения лабораторной работы был выбран язык программирования **python** с драйвером **psycopg2.**

Будем генерировать данные рандомно с помощью библиотеки **Faker.**

Вначале запустим [script1](https://gitlab.icc.spbstu.ru/rejmer.id/db-course/-/blob/lab2/script1.sql), который был создан в рамках лабораторной работы 1-2 _(используемый скрипт имеет модификацию - изменено имя БД на универсальное название без привязки к номеру лабораторной работы - **board_game_reymer**, в остальном - без изменений)._ Данный скрипт пересоздаст БД и создаст все необходимые таблицы. 

Далее запустим [генерацию данных](https://gitlab.icc.spbstu.ru/rejmer.id/db-course/-/blob/lab2/main.py). Имеются несколько параметров генерации:
- --clear - параметр для очищения всех таблиц от данных (default=False)
- --users - параметр определяющий количество записей, которое необходимо создать в таблице user (default=1)
- --games - параметр определяющий количество записей, которое необходимо создать в таблице board_game (default=1)
- --feedback - параметр определяющий количество записей, которое необходимо создать в таблице feedback (default=1)
- --collections - параметр определяющий количество записей, которое необходимо создать в таблице collection (default=1)
- --sales - параметр определяющий количество записей, которое необходимо создать в таблице sale (default=1) 

Рассмотрим генерацию данных для каждой таблицы:

Определим 9 категорий игр: family, party, detective, strategy, horror, thematic, customizable, abstract, wargames.

При генерации данных будем проверять, все ли категории есть в таблице **category** и при необходимости дополним ее категориями. 

В зависимости от параметра --games создадим записи в таблице **board game.** 

Дату выхода игры release будем определять в пределах от 01.01.2005 _(пусть это будет дата создания интернет магазина)_ до текущего момента. Также рандомно генерируем флаг gen _(True/False)_, по которому будем определять, генерировать ли значение или оставить None (в допустимых случаях). 

Уникальность названия игры обеспечим за счет добавления к рандомно сгенерированному названию uuid4.
uuid4 обеспечивает 5.3 ундециллиона _(5.3*10<sup>36</sup>)_ возможных вариантов uuid4. Однако, если всё же случится генерация одинаковых названий, то будет выведена соответствующая информация о дубликате названия и запись не будет добавлена в таблицу.

Если запись об игре будет добавлена, то добавим запись в **category_intersection**: выберем максимальный _(последний добавленный)_ id игры и рандомную категорию. Также добавим связанную с рассматриваемой игрой информацию в таблицу **commerce**.

Наличие игры может принимать любое из значений: in stock, out of stock, no longer produced. В случае, если игры нет в наличии _out of stock_, рандомно генериуем дату поставки игры в магазин, в остальных случаях - None.

В зависимости от параметра --sales создадим записи в таблице **sale.** При генерации данных учитываем, что начало акции может быть в пределах со дня открытия интернет магазина до сегодняшнего дня, а дата окончания - со следующего дня от начала акции до некоторого большего значения. Далее добавим запись в **sale_intersection**: выберем максимальный _(последний добавленный)_ id акции и рандомную коммерческую информацию. 

Заполним таблицу **collection** в соответствии с параметром --collections. Далее добавим запись в **collection_intersection**: выберем максимальный _(последний добавленный)_ id коллекции и рандомную игру. 

Далее добавим пользователей: униальность почтового адреса и никнейма вновь обеспечим добавлением uuid4, пароль - рандомно сгенерированный sha256. Если уникальность не соблюдена, также выводим информацию о дубликате и отменяем запись в таблицу **user**.

Количество сгенерированных пользователей определяем параметром --users. В зависимоти от этого параметра также создаем записи и в таблицу **order**. Заказ может иметь одно из трех состояний: in progress, ready, delivered, значение которого определяется рандомно. Стоимость заказа составляет число от 10 до 10000. Это значение, в нашем случае, генерируется рандомно, а не берется из таблицы commerce, так как стоимость с момента заказа могла измениться. Дата заказа также формируется в пределах от 01.01.2005 до сегодняшнего дня.
При формировании заказа проверяем, что возраст рандомного выбранного пользователя больше _(или равен)_ возрастного ограничения у рандомно выбранной игры, иначе заказ не будет сформирован. Если заказ сформирован, добавляем запись в таблицу **cart_intersection**.

В зависимости от параметра --feedback создадим записи в таблице **feedback.** Дата публикации обратной связи формируется в пределах от 01.01.2005 до сегодняшнего дня. Генерация отзывов и вопросов происходит по флагу gen _(True/False)_, в зависимоти от которого получим рандомно сгенерированный текст или None. Запись будет добавлена в таблицу feedback, если есть вопрос или отзыв, иначе запись не будет добавлена.

При запуске с параметром --clear True все таблицы будут очищены и затем сгенерируются новые данные. При значении --clear False _(default значение)_ созданные ранее данные хранятся в БД и генерируются новые.

### Вывод

В ходе выполнения лабораторной работы 2 была создана программа для формирования наборов связанных данных в каждой таблице. Количество записей определяется параметрами генерации, значения для внешних ключей берутся из связанных таблиц, соблюдены ограничения, осуществлено сохранение уже имеющихся данных в БД. Учтена возможность очищения таблиц при необходимости. Получен навык работы с psycopg2.
